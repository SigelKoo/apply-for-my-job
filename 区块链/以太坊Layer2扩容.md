# 给初学者的 Layer 2 指南

考虑到安全性和流动性（或者不在乎那千把块美元的 gas 费），你想取回本息并放到以太坊上。如果你随时随地都能从 Macau 存款合约（再强调一次，这个合约在以太坊区块链上）中取回 200 Dai，且没人能阻止你（只有当满足这两个条件时），Macau 就是 Layer 2 区块链。

如果从理论上来说 Macau 的验证者可以阻止你取回 200 Dai，或直接偷走它们（自己取走），Macau 就不是 Layer 2 区块链，而是侧链。

如果从理论上来说你可以取走更多资金（如 300 Dai），Macau 就不是 Layer 2 区块链。

**如何将以太坊上的存款合约变得更加智能，来防止你、其他 Macau 用户以及 Macau 的矿工/验证者/运营方作弊呢？**

状态通道和 plasma 等早期解决方案的做法是：**将欺诈声明和争议解决逻辑编程到 Layer 1 上的存/取款合约中**。但是，它们都给用户造成了沉重的负担，例如：

- 用户必须时刻在线监控以太坊上的 Layer 1 合约，以便挑战/制止/惩罚威胁其资产的恶意取款行为。
- 用户必须存储提出争议所必需的数据。在状态通道方案中，这个数据通常是对手方的签名，用来证明通道中的状态变化（例如，“Alice：我保证向 Bob 支付 10 Dai” 或 “Charlie：我保证将车移动到棋盘上的 H5” ）。
- 只针对 plasma：用户容易受到两方面影响（a）需要存储的数据大量增加，因为用户所需数据是 plasma 链全局状态的一部分，而不只是状态通道的对手方的数据 ，（b）数据扣留攻击（data withholding attack），即，plasma 运营者（区块生产者）试图进行恶意取款，同时扣留用户发起挑战所需的数据。这进一步提高了 Layer 1 上取款安全性逻辑的复杂性。

直到 rollup 方案出现，才真正解决了这些棘手的问题。**rollup 要求用户退出时所需的一切数据都能在 Layer 1 上获得**。每当 Layer 2 上的状态变化时，rollup 运营者都会在 Layer-1 上披露导致本次状态变化的事务数据。因此，Layer 2上的执行和 Layer 1 上的数据更新是同步的。

rollup 方案通过数学方法（ZKRU）或密码学货币经济（ORU）保障来确保所有相关参与方都是诚实的。如果 rollup 运营者消失或开始捣乱【滥发信息、审查或（在 optimistic rollup 方案中）实施欺诈】，用户总是可以使用 Layer 1 上的数据来安全地取走资金。这些数据都存储在以太坊 Layer 1 上的 rollup 合约中，因此用户唯一需要信任的就是 Layer 1 会诚实地执行这些合约（其它 Layer 1 合约也采用同样的信任假设，如 MakerDao MCD 和 Aave 等）。

ZK Rollup 方案采用有效性证明来证明 rollup 状态更新的正确性。每当 rollup 状态更新，有效性证明都会在 Layer 1 上验证。因此，这类方案可以杜绝欺诈行为。**但是，数据还是要发布到链上。这样一来，如果 rollup 运营者消失，用户依然能够使用数据来自行提交取款请求。**

**说回侧链**：

如果 rollup 有这么神奇，那为什么有人会选择创建一个（a）需要额外的信任假设和（b）过去 7 年来始终得不到市场认可的侧链？

**侧链之所以苟延残喘，是因为这类方案很容易构建**。很多项目方只是草草构建出一个侧链，就可以拿风投🤡，然后发行代币。

实际上，只需要一下午时间，你就可以构建出一条以太坊侧链：你只需要在以太坊上构建一个类似智能钱包的基础合约让人们能够存入资金，然后分叉 Geth（为你的侧链选一个新的链 ID 并重新构建即可）……瞧！这不就差不多了……呃，好吧，还差一点……你还得雇一些水军，再请平面设计师设计一个高大上的网站……不过很多风投机构想必都很乐意帮你一把，它们可以部署大量机器人。

一些骗子会忽悠你说侧链就是 Layer 2 方案，更有甚者还会宣传说他们的侧链比 rollup 更安全。然而，说到底，这只是一个很简单的问题：资金出口由谁控制？在 rollup 方案中，资金出口是受到控制的，并由以太坊 Layer 1 的 EVM 保护。

# 千层蛋糕：Layer-2 指南

以太坊 1.0 的事务吞吐量是很有限的，这也导致了发送事务的代价异常高昂。

以太坊事务的主要代价来源于：

- 状态存储项变更的成本
- 事务数据的成本
- 计算成本

Layer-2 方案则把上述的一项或多项外包给一个依赖于以太坊的次级网络。

一般来说大家把 Layer-2 方案分为两类，各有各的安全要求和取舍：**optimistic rollup** 和 **zk rollup**。

## Optimistic Rollup

Optimistic rollup 就像是以太坊区块链的缩影。它有自己的一个网络，也承载智能合约和事务。

Optimistic rollup 方案会定期广播其事务区块到 Layer-1 的某个智能合约中。这些 “区块” 包含且仅仅包含该 Optimistic rollup 系统中发生的事务的数据。这个位于 Layer-1 的智能合约也不执行任何计算或更新存储项。这就大幅降低了发布一个区块的开销。

之所以称作 “optimistic”，是因为这样的系统假设了发布出来的 L2 区块中的每一笔事务都是有效的 —— 智能合约不会直接检查它们的有效性。

相反，如果某个用户认为某笔事务是不正确的（例如导致了多重支付），他们可以发布一条 “欺诈证明（fraud-proof）”。Layer-1 上的智能合约可以使用该 rollup 已经发布的数据来验证被指控的事务的有效性。

欺诈证明本身的开销是很大的，但只需要在疑似发生恶意行为的时候才需要执行。

如果恶意行为被坐实，那么发布了这个 optimistic rollup 区块的主体（一般来说称为 “验证者”）就会损失他们事先锁定的密码学货币。

Optimistic rollup 依赖于这种经济学的共识来保证事务都是正确的。

从 Optimistic rollup 中取款的时间一般比较长（例如 1 周）。这是因为事务被公开以后，用户要等待看是否有人指控发生了恶意行为。（有点像婚礼上牧师会问 “是否有人反对这门亲事……” 然后大家陷入尴尬的沉默）

在 Optimistic rollup 上执行事务的主要成本来自于要把这些事务的数据发到底层链上的成本。这一 *数据可得性* 问题是所有 rollup 都共有的，既包括 optimistic，也包括其他类型的。为了防止资金被冻结，用户必须能够访问到一个 rollup 自始至终的所有事务数据。要么这些数据要发到 layer1 上，要么用户就需要额外的信任（例如，相信侧链会公开这些数据）。

在本文撰写之时，如果你所在的 rollup 不会公开你的事务数据到链上，那你就得寄希望于中心化的服务商不要冻结你的资金了。（译者注：这种说法有点莫名其妙，如果一个 optimistic rollup 不发布事务数据到链上，那它就不叫 optimistic rollup，叫 Plasma。）

## ZK Rollup

计算和状态存储都由二级网络来承担。

L2 将事务数据连带相关的 *有效性证明* 一起广播到 L1 主网上。所谓 “有效性证明”，就是这些事务有效性的数学证明。一批的 L2 事务都被 *汇总（roll up）* 成一笔发往 L1 某个智能合约的事务。

“ZK” 这个前缀指的是 “零知识证明（zero knowledge）”，不过，zk rollup 往往不能保护隐私 —— 所有的事务都会默认公开，就像 Optimistic rollup 一样。使用 “zk” 这个前缀是因为这些系统所依赖的 *有效性证明* 往往是用零知识证明系统来生成的（例如 ZK-SNARK 或者 ZK-STARK）。

这种方案的好处在于，存储项更新和计算的开销都从以太坊主链上移除了，而且，也不需要乐观地假设广播出来的事务是正确的，只要证明是有效的，你就 *知道* 这些事务是有效的。

这也意味着，取款时间可以比 Optimistic rollup 类的系统快得多，所需的信任假设也更少。

但房间里的大象是，零知识证明给一笔事务附加了**惊人**的计算开销。

为一段计算生成一个零知识证明的计算开销大约是直接运行这段计算的 100 万倍！这是一个粗略的估计，实际情形可能因原计算本身的特点而有很大差别，但对于 Solidity 智能合约类型的计算程序来说，（这个估计）是大体准确的。

ZK rollup 系统的应对方法是将建构证明的任务委托给拥有大量计算资源的第三方，称为 “rollup 供应商”。用户要依赖这些第三方服务来为他们创建交易。Rollup 供应商可以审查或者抢跑这些事务，就像以太坊的矿工可以做的那样。所需的计算力越多，有能力充当供应商的主体就越少，所以我们必须从协议架构上充分考虑审查问题。

巨大的计算开销也给智能合约的移植带来了一些问题。完全兼容 EVM 是我们的目标，那就必须处理这 100 万倍的减速效果。EVM 对 SNARK 极度不友好，因为其字长是 256 位的，而且原生支持 SHA3 和其它对 SNARK 不友好的哈希算法。即使能够把生成证明的计算开销外包给拥有大量计算资源的主题，可能也是不够的。一种可能的办法是把 zkSNARK 的证明器算法直接写到 FPGA 硬件或者 ASIC 中。那么提供商就需要这种硬件来建构证明。

一般来说，SNARK 和 STARK 的编程语言都不得不适应底层证明系统的低效率。这些语言在实现变长的循环和动态内存访问（比如动态的数组和向量）时都会遇到困难。我们最新的 Plookup 研究缓解了某些问题，也还谈不上解决了所有问题。

这就意味着 zk rollup 需要开发者把他们的合约移植成定制化的编程语言（比如 Starkware 的 Cairo）。

对于不以完全兼容 EVM 为目标的 zk rollup 来说，好处是转账变得更便宜。如果无需遵循 EVM 的语义，就可以降低基本转账的广播数据量。Hermes network 就是这样做的。

## Private rollup

Aztec 已经在 2021 年 3 月推出了隐私 rollup。你可以把你的 ETH 封装到一个 privacy shield 中，并使用我们的在线隐私钱包 zk.money来发送隐私交易。

隐私 rollup 使用与 zk rollup 非常相似的技术，但特点完全不同。隐私 rollup 的架构是为了给 L2 的每一个用户提供强大的隐私保证。用户都是匿名持有资金。在运行交易的时候，发送者和接收者都是匿名的，而且转账金额也是加密的。

我们使用的是最先进的零知识证明系统 Plonk。我们在 2019 年发明了 Plonk，它很快就在使用零知识证明并在区块链上做开发的团队间成了行业标准。

在设计上就保证隐私性需要与 zk rollup 截然不同的 rollup 架构。我们采用了隐私优先的路径，因为我们知道，有了一个公开的 L2，再想植入可编程的隐私性，就往往需要牺牲用户体验或激进地重构整个协议。

当前基于以太坊的隐私解决方案是混币器（mixer）。混币器能够匿名化用户的资金数额，但除此之外用户有限。我们的完全版本的隐私型 layer-2 能做得更多：

- 完全可编程的隐私型智能合约。隐私货币因此有更高级的交易逻辑
- NFT 的隐蔽所有权
- NFT 的属性可以完全隐蔽，仅对所有者可见
- 反洗钱和 KYC 检查可以直接编程到隐私 token /dApp 中（例如 KYC token —— 你可以跟可信的对手方交易，而无需知道他们的真实身份）
- 隐私性 DeFi！这是个很大主题，需要专门写一篇文章来说（在写了在写了……）

只有一开始就把隐私放在首位，才有可能获得这些好处。协议的事务和状态模式也必须设计成与隐私特性相兼容。

# Layer 2 方案概览：从状态通道到 Roll Up

## 状态通道

我们先来看看入门级的 Layer 2 方案——支付通道。支付通道是如今最广泛采用的 Layer 2 方案。例如，闪电网络就是建立在支付通道技术上的。

支付通道是状态通道这个大概念下的一个具体实例。状态通道是固定一组参与者（通常是两名参与者）之间的协议，用以实现安全的链下交易，其中支付通道专门用来支付。支付通道协议具体如下：两名参与者各自通过链上交易在链上锁定保证金，比方说，价值 10 美元的比特币。一旦锁定完成，参与者双方即可互相发送形式为 [轮次，金额，签名] 的状态更新来实现转账，无需与主链进行交互，只要双方的余额都还为正值即可。

一旦参与者中有一方想要停止使用支付通道，可以执行 “退出” 操作：将最后的状态更新提交至主链，结算下来的余额会退给发起支付通道的两方。主链可以通过核实签名和最后结余来验证状态更新的有效性，从而防止参与者使用无效状态来退出支付通道。

这种 “退出” 模式存在一个问题，即主链无法验证支付通道是否提交了全部交易，也就是说，在提交了状态更新之后是否不再出现新的状态更新。我们可以考虑这样一个场景：

![img](https://upyun-assets.ethfans.org/uploads/photo/image/ebdef389e2aa4c028ebe585a4fb833f4.png)

假设在初始状态下 Alice 有 11 美元而 Bob 有 9 美元，Alice 向 Bob 发送了一个状态更新——向 Bob 转账 7 美元，并等待 Bob 向她提供服务，然后在 7 美元还没到账之前就退出了支付通道。由于主链不知道还有另外的状态更新，会将“退出” 交易视为有效。

这个问题的解决方案是，在 Alice 发起退出交易之后，为 Bob 留出一段时间的 “挑战期”。在此期间，Bob 可以提交未完成结算的状态更新，里面包含 Alice 的签名，而且轮次数也高于 Alice 在退出时提交的状态更新。在上例中，Bob 可以在挑战期内提交最后一个状态更新，也就是 Alice 向他转账 7 美元的状态更新，并且索要 16 美元的余额，而不是被 Alice 提交的状态搞得只剩下 9 美元。

虽然目前的退出机制设计非常安全，但是主要麻烦的一点在于：参与者可能得等待比较长的一段时间，通常是 24 小时，才能退出，而且需要频繁（至少每段退出期一次）监控主链以确保他们的交易对手方没有使用过去的某个状态退出。可以通过 **WatchTowers（暸望塔）**技术将监视全网的任务委托给第三方。

为了避免这种不必要的等待，双方可以通过许多实现来达成“协同关闭”。其中，参与者可以签署一个“结束证明”。有了这个证明之后，另一方无需等待挑战期结束即可退出。

支付通道可以广泛应用于任意的状态转换，而非仅仅局限于支付一途，只要主链可以验证这些状态转换的正确性即可。例如，状态通道可以用来下棋，棋手可以将各自的走棋作为交易发送给对方。

虽然存在不便之处，但是状态通道已广泛应用于支付、游戏等用例，因为这种技术具有即时确定性（一经交易对手方确认，状态更新即可得到最终确定），无需参与者交纳除质押和退出费用以外的其他费用，而且在结构上相对简单。

## 状态通道网络

状态通道的另一个缺点是只能在两个参与者之间开设。你可以通过 N/N 多签机制在多个参与者之间维护一条状态通道。不过相比之下，具备相同功能的 Layer 2 方案更为理想，使得彼此之间未开设状态通道的参与者也能直接进行交易。

状态通道还有一种很有趣的架设方法。如果 Alice 跟 Bob 之间有一条状态通道，Bob 和 Carol 之间也有一条状态通道，那么 Alice 就可以通过 Bob 安全且自动地转账给 Carol 。这样就可以构建一个完整的状态通道网络，容许大批量的参与者彼此进行交易，无需在每一对参与者之间开设状态通道。

这就是闪电网络的设计思路。

## 侧链

侧链的核心思路是构建一条完全独立的区块链，有自己的验证者和运营者，可以与主链互相转移资产，而且会选择性地将区块头的快照发送至主链，从而防止分叉产生。有了这些快照，就可以有效防止分叉，即便侧链上的验证者串谋起来发动分叉攻击也没用。

![img](https://upyun-assets.ethfans.org/uploads/photo/image/d17b6ba2b64f41a899c3bf7a63291a05.png)

从上图可以看出，侧链会生成区块并将它们的快照发送至主链。所谓的快照就是存储于主链上的区块哈希。侧链上的分叉选择规则是，合法的链必须构建在最近一个进行过快照的区块之上。在上图所示情况下，区块 A 的快照已经发送至主链，即使侧链上的验证者勾结起来，试图在区块 A 生成之后生成一条更长的 A’<-B’<-C’ 链来发动双花攻击，侧链上的参与者也会忽略这条更长的链。

如果参与者想要将主链上的资产转移至侧链，他们就要将这部分资产“锁定”在主链上，并向侧链提供锁定证明。如果要解锁主链上的资产，就要在侧链上发起一个“退出”交易，并在该交易被打包上侧链之后提供退出证明。

虽然侧链可以利用主链的安全性来防止分叉，但是验证者依然可以通过串谋来发动另一种叫做 *无效状态转换* 的攻击。这种攻击背后的思路是，主链本来就不可能验证侧链上的所有区块（真要这样做，做侧链就没有意义了，侧链就是希望主链不必验证所有交易）。因此，如果有超过 50% 或 66%（取决于侧链的架构）的验证者串谋的话，他们可以创建一个完全无效的区块，窃取其他参与者的资产，并将这个区块的快照发送至主链，发起并完成一个“退出”交易，就可以成功偷走这些资产。

那篇概述中还提到了避免无效状态转换问题的解决方案，不过目前还没有践行。大多数侧链都是基于验证者串谋人数占比不超过 50%（或 66%）的设想之上的 。

## Plasma

Plasma 是一种可以实现 “无监管” 侧链的技术，换言之，即使侧链（通常被称为 “plasma 链”）上所有验证者串谋起来作恶，plasma 链上的资产也是安全的，而且可以退回主链。

最简单的 plasma 设计通常被称为 Plasma Cash ，只支持简单的非同质化代币，而且每个交易转移的资产只能是一个特定的常量。Plasma Cash 的运行方式如下图所示：

![img](https://upyun-assets.ethfans.org/uploads/photo/image/f8c724dfc2e64ef5856e8099fc29afbc.png)

每个区块都含有一个稀疏默克尔树（Sparse Merkle Tree），它的叶节点则包含某个代币所有权的 *变更* 。以上图为例，一共有 4 个代币处于流通中。在区块 B 中，代币 1、3 和 4 没有被换手（叶节点中显示为 *空* ）， 而代币 2 被转移到了 Alice 手中。如果区块 D 中包含一个由 Alice 签署的将代币 2 转移至 Bob 的交易，则区块 D 中的代币 2 会从 Alice 手中转移至 Bob 手中。

一个代币从主链转移到 Plasma 链上之后，如果一方要将这个代币转移给另一方，则需要提供这个代币的完整历史。在上例中，如果 Bob 想要将代币 2 转给 Carol ，那么之前每个区块内的交易情况就会作为条目记录在这个交易内，如果之前发生过所有权变更，需将相关默克尔证明记录在内，反之记为空值。

Plasma 链会将所有区块头的快照发送到主链上，Carol 可以验证是否所有的默克尔证明都跟之前通过快照发送至主链的哈希值相符，以及每个区块中的所有权变更是否有效。一旦这个交易被打包成区块放到 plasma 链上，Bob 将代币 2 转给 Carol 的条目就会记录在默克尔树上，Carol 就成了代币 2 的所有者。

因为 Plasma 是建立在运营者随时都能串谋作恶的设想上的，所以用户没法做到即时退出（因为 plasma 运营者提出的状态快照哈希值是不能被信任的），而且需要有一个退出机制。尽管我们上文讨论的架构相对简单，但是退出机制非常复杂。

总而言之，Plasma 最大的优点是存储在 plasma 链上的代币安全性很高。无论发生了以下何种情况：plasma 运营者（在诚实的参与者收到代币之前或之后）创建了一个无效状态转换、plasma 运营者发起扣块攻击、plasma 运营者彻底停止出块，诚实的参与者都可以确信自己能够取回代币。在上述情况下，或者笼统地说，在任何情况下，代币都不会丢失。

缺点在于，在转移代币之时必须提供该代币的完整历史，另外就是退出机制非常复杂（以及相关的推论过程）。

## Roll Up

正如我在讨论侧链时提到的那样，解决侧链的无效状态转换问题的方法之一是提供密码学证明来证明之前每次状态转换都是正确的。

Roll Up 实际上是一条侧链，因此它会生成区块，并且将这些区块的快照发送到主链上。不过，Roll Up 上的运营者是无需信任的。也就是说，Roll Up 假定运营者可以在任何时候做出停止出块、生成无效块、隐瞒数据等恶意行为。

与一般的侧链相似的是，如果某个区块的快照已经发送至主链，那么 Roll Up 上的运营者只能在这个区块之后发动分叉攻击。因此，一旦某个区块的快照发送到了主链上，这个区块就得到了最终确定，Roll Up 链上进行过快照的区块也是如此。

为了避免状态有效性问题，每当 Roll Up 运营者要对某个区块进行快照之时，都要提供一个 SNARK（简洁化的非交互式知识证明），证明链已经使用相关的一组交易执行了有效的状态转换。以下图为例：

![img](https://upyun-assets.ethfans.org/uploads/photo/image/23845b7f75ec46c38418e3cf909b839f.png)

Roll Up 链上有三个区块：A、B 和 C 。它们的快照分别对应主链上的区块 X、Y 和 Z 。每到一个时间点，主链只需要存储 Roll Up 链上最新状态的默克尔根。在区块 A 进行快照之时，发送到主链上的交易包括：

1. 新状态 S2 的默克尔根 h(S2)。
2. S2 的完整状态数据，或区块中的所有交易。
3. 一个 zk-SNARK，证明在从状态哈希 h(S1) 到状态哈希 h(S2) 之间的所有交易都是有效的，并且这些交易都与 （2）中提供的数据相匹配 。

该交易证实了 zk-SNARK 是有效的，并在链上存储了新的默克尔根 h(S2) 。重要的是，该交易虽然不会将 A 中的完整数据存储在状态中，但是会将其保存在调用数据（call data）内，以便日后调用。

事实上，将完整的区块存储在调用数据中的做法在某种程度上是个瓶颈，不过可以解决数据可用性问题。目前，Matter Labs 构建的 Roll Up 需要 1 分钟的时间来计算出一个交易的 SNARK（多个交易可以并行计算），每个交易需要消耗 1K gas ，并占用主链上 9 个字节的调用数据。

在这样的设计下，除了离线之外，运营者不能做其他恶意行为：

1. 不能隐瞒数据，因为对区块进行快照的交易必须提交完整的区块或者完整的状态作为证明，并验证交易内容是正确的，之后交易内容会保存在主网上的调用数据内。
2. 不能生成含有无效状态转换的区块，因为必需提交一个 zk-SNARK 来证明状态转换的正确性，而无效区块是无法计算出 zk-SNARK 的。
3. 无法发动分叉攻击，因为分叉选择规则始终认可最新进行过快照的区块所在的那条链，即使这条链不是最长链。

虽然这种 Layer 2 方案没有显著扩大调用数据中的存储空间，但是实际消耗的可写存储量是恒定的（而且非常小），链上验证的 gas 成本低至 1k gas/tx ，是主链交易的 1/21 。

重要的是，假设 Roll Up 上的运营者彼此合作的话，就可以实现即时退出，不会涉及到退出机制。这些特征使得 Roll Up 链成了目前最炙手可热的 Layer 2 方案之一。

# 以太坊 Layer-2 方案的现状

## 链下通用可扩展性方案

此类方案是当前最活跃、讨论最充分的以太坊可扩展性方案。虽然 “*通用可扩展性*” 一词在技术上不够准确，但这个词确实反映了此类方案的目标：扩展任意以太坊交易（包括智能合约交易）的处理量。相较于简单的、实现链下支付的方案，这类方案要解决的问题要难得多。从技术角度来看，此类方案可以叫做 “承诺链”，可以扩展任意交易的吞吐量。

在这个领域内，虽然基于不同的技术维度可以细分为很多小类，但我们就简单分类成：

1. Plasma 链
2. 交易分组及压缩方案（Rollup）

抽象地来看，Plasma 方案就是（在主链网络以外）创建了一个可以执行任意交易的空间。但是，在 Plasma 方案中，因为链下交易的数据对以太坊主链是不可见的，这就使得用户想 *离开* 侧链、回到以太坊主链的时候，会遇上麻烦。这就是所谓的 *数据可用性* 问题。

![4.png](https://upyun-assets.ethfans.org/uploads/photo/image/8d072cf344b8456da0246d06d6403b02.png)

\- 以太坊侧链的简化图示 -

另一方面，Rollup 方案可以被认为一种压缩技术。多笔交易可以压缩在一起，既能减少 *交易数据规模*，又能降低 *交易验证负担*，因此使得以太坊区块链能处理更多交易。此外，所有交易的收据都存储在以太坊区块链上，这就提升了 Layer-2 交易的安全性。

**基于 Plasma 的方案**

Plasma 方案是最早出现的，以 Vitalik 的Plasma 论文为标志。Plasma 实现也因应用场景不同而大不相同。第一个 Palsma 的产品级实现是 Loom Network 于 2018 年使用 Plasma 的变种 *Plasma Cash* 做出来的。 Plasma Cash 主打非同质代币（NFT）和游戏。这个项目最终离开了以太坊生态，创建了一条独立的区块链，而且转变方向做起了企业性应用。Loom 是一个很有趣的案例，显示了 Layer-2 项目所面临的艰难，尤其在他们所瞄准的主要应用场景（比如游戏）并没有与 ETH（作为一种金融资产）深度绑定的时候。

**Rollup 方案**

Rollup 可扩展性方案算是初出茅庐。Rollup 方案通过把所有交易数据 *以 打包/压缩 过的形式* 存储在以太坊区块链上来解决数据可用性问题。交易合并为组的主要目的是节省验证成本。这些成组的交易不会由以太坊共识机制来直接验证，而是用另一种机制来证明这些交易的有效性。Rollup 方案有两大子类：Optimistic Rollup 和 zk Rollup，证明有效性的方法也不同。Optimistic Rollup 方案使用 *错误性证明（Fraud Proof）* 来揪出无效的交易、惩罚允许通过这些交易的验证者。zk Rollup 使用零知识证明（例如 SNARKs）来证明所处理 Layer-2 交易的有效性。证明本身也会跟交易数据一起存储在脸上。

# 各以太坊 Layer 2 扩容方案的评估对比

## 概述

为了简化问题，我们的评估将从以下四个方面着手，分别是：

1. 安全性（Security）
2. 性能（Performance）/经济性（economics）
3. 易用性（Usability）
4. 其他

希望我们的综合比较可以帮助开发者评估不同的扩容解决方案，并采用最适合其需求的解决方案。

除了这些问题之外，我们还汇总了一张对照表（译者注：这张表是本文的重点），可作为与解决方案提供商对话的起点。我们尽了最大努力保持对比的中立和客观，但是在表格里简洁地表达不同方法的细微差别仍然是一项艰巨的任务。我们希望更多的上下文能弥补这一问题。

> 非常感谢 Georgios Konstantopoulos（Layer 2独立研究员），John Adler，Ben Jones，JD Kanani，Patrick McCorry，Justin Drake（以太坊基金会）和Brecht Devos（Loopring 路印），感谢他们对该表的审查和更正。

|                                    | 状态通道    | 侧链 0               | Plasma     | Optimistic Rollup    | Validium    | zkRollup         |
| ---------------------------------- | ----------- | -------------------- | ---------- | -------------------- | ----------- | ---------------- |
| **示例**                           | Pisa、Celer | Skale、PoA           | OMG、Matic | OVM、Fuel            | StarkEx     | zkSync、Loopring |
|                                    |             |                      |            |                      |             |                  |
| **安全性**                         |             |                      |            |                      |             |                  |
| 在线假设（例如瞭望塔）             | 有          | 使用保证金机制来绕过 | 有         | 使用保证金机制来绕过 | 无          | 无               |
| 大量退出能力假设                   | 无          | 无                   | 有         | 无                   | 无          | 无               |
| 验证者可联手冻结资金               | 不可        | 可                   | 不可       | 不可                 | 可          | 不可             |
| 验证者可联手盗取资金               | 不可        | 可                   | 不可       | 不可                 | 可 1        | 不可             |
| 运营者密钥暴露风险                 | 高          | 高                   | 一般       | 一般                 | 高          | 低               |
| 密码学经济学攻击风险               | 一般        | 高                   | 一般       | 一般                 | 一般        | 低               |
| 密码学元件                         | 标准        | 标准                 | 标准       | 标准                 | 新          | 新               |
|                                    |             |                      |            |                      |             |                  |
| **性能/经济性**                    |             |                      |            |                      |             |                  |
| 在 Eth1 上的最大吞吐量（TPS）      | 1~无限 2    | 10 K+                | 1~9 K+ 2   | 2K 3                 | 20 K+       | 2 K              |
| 在 Eth2 上的最大吞吐量（TPS）      | 1~无限 2    | 10 K+                | 1~9 K+ 2   | 20 K+                | 20 K+       | 20 K+            |
| 资金利用的效率性                   | 无          | 有                   | 有         | 有                   | 有          | 有               |
| 需要额外的链上交易来开启一个新账户 | 是          | 否                   | 否         | 否                   | 否          | 否 5             |
| 交易手续费                         | 极低        | 低                   | 极低       | 低                   | 低          | 低               |
|                                    |             |                      |            |                      |             |                  |
| **便利性**                         |             |                      |            |                      |             |                  |
| 取款时间                           | 1 笔交易    | 1 笔交易             | 1 周 4、7  | 1 周 4、7            | 1~10 分钟 7 | 1~10 分钟 7      |
| 主观终局性时延                     | 即时        | 无（信任运营者）     | 1 笔交易   | 1 笔交易             | 1~10 分钟   | 1~10 分钟        |
| 中观终局性的客户端验证             | 可          | 不可（信任运营者）   | 不可       | 不可                 | 可          | 可               |
| 即时的交易确认                     | 满足        | 部分满足             | 部分满足   | 部分满足             | 部分满足    | 部分满足         |
|                                    |             |                      |            |                      |             |                  |
| **其它维度**                       |             |                      |            |                      |             |                  |
| 智能合约灵活度                     | 有限        | 灵活                 | 有限       | 灵活                 | 灵活        | 灵活             |
| EVM 字节码可移植性                 | 不可        | 可                   | 不可       | 可                   | 不可        | 不可             |
| 原生隐私选项                       | 有限        | 无                   | 无         | 无                   | 有          | 有               |

> 注：
>
> 0 某些研究完全不认为侧链应被归入 L2 范畴，可见：https://twitter.com/gakonst/status/1146793685545304064
>
> 1 要看相关升级机制的实现，不过一般来说都可以
>
> 2 有非常复杂的限制
>
> 3 为保证与 EVM 的可组合性，吞吐量的上限是 300 TPS
>
> 4 这个参数实际上是可调的，但大部分研究员都觉得 1 到 2 周时间比较安全
>
> 5 要看相关的实现。zkSync 是不需要的，但 Loopring 需要
>
> 7 理论上来说，可以通过流动性提供商缓解这个问题，但是会让整个方案的资金利用效率性变差

## 1. 安全性

### 在线假设（例如：瞭望塔）

协议是否要求用户在线（liveness）？换句话说：是否需要用户自己或通过受信任的代表（如：瞭望塔）监控扩容解决方案在链上（即 L1 层）的所有活动？

在某些情况下，可以将监控需求委派给受信任的各方，并提供与其服务用户一致的激励措施（如：通过担保）。但是，需要注意，如果受信任的代表在行为不当，其损失的金额始终不会超过保证金的大小。

大家应该考虑受信任的代表是否有机会窃取比保证金更多的价值，以及能在多大程度上承受这种风险。

### 大量退出能力假设

扩容解决方案的安全性假设是否包括所有用户都能在短时间内成功退回到L1层（用户提款退出）？

如果出于安全原因，L2扩容方案的所有用户需要在短时间内退出L2时，就出现这个情况。如果他们选择留下，则运营者可能会进行一些操作耗尽仍留在L2中的资金。例如，在 Matic 方案中，所有用户退出的窗口为 1 周。

但是，在网络拥塞和 DoS 攻击的情境下，这个假设能不能成立是很成问题的。例如，在给定时间范围内大规模退出，以太坊网络可能高度拥堵，可能导致交易无法及时打包。即使网络并不拥堵，攻击者仍可以尝试操纵 GAS 价格以致交易不能及时处理。这是值得考虑的攻击手段。

### 托管性（Custody）

达到特定数量的 L2 验证者能否无限期禁止用户操作自己的资金？他们可以窃取用户资金吗？

如果希望在项目保持不受审查，那么这点尤其重要。

### 运营者热钱包秘钥暴露风险

L2 扩容方案的资金安全是否取决于操作员保护密钥（即热钱包密钥）的能力、而密钥又必须时刻在线以保持系统正常运行？

### 易受加密货币经济攻击

扩容方案应对加密经济攻击有多脆弱？是否基于博弈论假设？

有多种涉及加密经济诱因的攻击，包括：贿赂 L2 验证者（或其操作人员），贿赂 L1 上的矿工，创建黑产 DAO 等。这些攻击手段正在迅速发展，而依赖于博弈论假设的扩容系统，难以证明可以根除这些攻击。

同样还包括从技术上讲不是盗窃但实际上是等效的场景。例如，对 Validium 的双花攻击，攻击者无法通过设计窃取其他人的资金，但仍然可以双花自己的资金。

### 密码学元件

解决方案是否依赖于标准密码学，还是利用了新颖的密码学研究，例如 SNARK 或 STARK？通常，越早创造的密码学元件，被破解的机会就越小。越是最先进的和最近的原语，则对团队实现的能力要求更高，并且需要有更多审核。

## 性能/经济性

### 最大吞吐量

在以太坊 1.0 上扩容方案的最大可能吞吐量是多少？在以太坊 2.0 上呢？

尽管今天解决方案的吞吐量可能令人满意，但是有理由展望未来，并预测额外吞吐量的需求，以及计划采用的解决方案是否能够适应未来。

### 资本利用效率

扩容解决方案的资本利用效率如何？是否需要大量资金才能运作？

对用户而言，资本利用效率较低的系统成本会更高，并且可能会由于缺乏即时流动性而导致运营中断。例如，支付通道的资金利用效率相对较低，因为通道运营商必须锁定其平均通道数量的倍数，以确保通道不会达到容量上限。

### 开立新帐户的成本

刚开始使用 L2 的新用户是否需要在 L1链上提交交易以在 L2 上开启账户？

在比较表中，我们指出了方案的最佳实现是否需要提交交易，但是方案的实现可能会有差异。例如，zkSync 和 Loopring 都使用 zkRollup，但是 Loopring 要求用户进行L1交易来开设帐户，然而 zkSync 却不需要。

## 易用性

### 提款时间

提款到 L1 需要多长时间？为了解决争端，某些解决方案中的取款可能需要等待一周或更长时间。为了减轻这种漫长的等待时间，是否有流动性提供者为用户提供流动性以换取风险溢价？如果存在这样的流动性提供者，它们的可靠性和成本如何？由于快速提款也需要付出一定的代价，所以使用这种解决方案的真正代价有多大？

### 达到主观终局性（subjective finality）的时间

在协议的安全性假设下，交易需要多久达到不能在 L1上被回滚的状态？

我们用主观终局性（subjective finality）一词的意思是，即使 L1 智能合约仍不能依赖此状态，也可以说服外部观察者相信交易的不可逆性。例如，在 Optimistic Rollup 中，只需在以太坊上得到一次确认就能达到 L1 终局性，而完全终局性则需要大约1周的时间。

### 主观终局性的客户端可验证性

轻客户端（浏览器/手机钱包）是否能核实达到主观终局性的时间（请参见前面的问题）？

继续上面的示例， 在 Optimistic Rollup 中，进行 1 次确认就能达到 L1 终局性，但要确认交易是最终的，则必须下载整个 Rollup 状态并执行上周的所有交易，以确保所有的 Optimistic Rollup 块都是正确的。

### 即时交易确认

扩容方案可以提供完全的交易即时确认，还是担保下的即时确认？

大多数 L2 协议实现了 “即时表观终结性”，即，交易似乎将在 UX（用户体验）上得到了即时确认。但只有支付通道（状态通道）为这些确认提供完整的安全保证，而在其他协议中，这些交易仍可以在 L1 中确认之前的一段时间内撤销（revert）。不过，撤销它们（不管是否成功）需要付出代价，它们都会因此失去一些安全保证金（即抵押存款）。

交易即时确认也取决于扩容解决方案的具体实施细节。