# https://ethfans.org/posts/layer-2-for-beginners-by-ali

Layer 1 区块链具有更高的安全性和流动性，Layer 2 区块链则依赖 Layer 1 区块链为其提供安全性和流动性。

其实是将你的 100 Dai 发送到以太坊区块链上的另一个合约，也就是通常所说的 “存款” 合约

第一步：将 100 Dai 发送到Macau 在以太坊区块链上的存款合约。

第二步：你已经从 Macau 获得了 100 张借据（好比是赌场筹码）。凭这些借据，你可以取回你在以太坊上的存款合约中锁定的 Dai。我们称这些借据为合成 Dai（简称 sDai）。

第三步：将 Macau 上的 100 sDai 用于交易、流动性挖矿、投资等。

假设你玩德州，将 100 sDai 的本金翻倍变成了 200 sDai（这多出的 100 sDai 是你从对手那里赢来的，他们也在以太坊上的 Macau 存款合约中锁仓了一笔 Dai）。

考虑到安全性和流动性（或者不在乎那千把块美元的 gas 费），你想取回本息并放到以太坊上。如果你随时随地都能从 Macau 存款合约（再强调一次，这个合约在以太坊区块链上）中取回 200 Dai，且没人能阻止你（只有当满足这两个条件时），Macau 就是 Layer 2 区块链。

如果从理论上来说 Macau 的验证者可以阻止你取回 200 Dai，或直接偷走它们（自己取走），Macau 就不是 Layer 2 区块链，而是侧链。

如何将以太坊上的存款合约变得更加智能，来防止你、其他 Macau 用户以及 Macau 的矿工/验证者/运营方作弊呢？

可以想象得到，这并非一件容易的事，因为这需要存款合约能够实时了解 Macau 上的资金流向：假设 1 小时前你在 Macau 上玩德扑赢了 100 sDai，你就可以提取 100 Dai 到以太坊上，但是你可能在下一局就把这笔钱输掉了！因此，合约要能了解所有这些情况，以及 Macau 的最新状态。

状态通道和 plasma 等早期解决方案的做法是：将欺诈声明和争议解决逻辑编程到 Layer 1 上的存/取款合约中。但是，它们都给用户造成了沉重的负担，例如：

- 用户必须时刻在线监控以太坊上的 Layer 1 合约，以便挑战/制止/惩罚威胁其资产的恶意取款行为。

- 用户必须存储提出争议所必需的数据。在状态通道方案中，这个数据通常是对手方的签名，用来证明通道中的状态变化（例如，“Alice：我保证向 Bob 支付 10 Dai” 或 “Charlie：我保证将车移动到棋盘上的 H5” ）。

  如果是状态通道，根本没有什么 “Macau” 链，用户之间直接进行交互。例如，你在以太坊上质押了一笔 Dai，和一群小伙伴开了个状态通道打德扑，然后开始交换信息来更新游戏状态，如 “我弃牌，以这个密码学签名为证”。等游戏结束后，你可以向以太坊上的合约提交这局德州的最新快照，然后取出你的余额。支付通道和象棋通道也是同理。虽然状态通道方案可以消除来自恶意侧链运营者的风险，但是用户依然需要保持警惕，以防对手方试图使用已经过时的有效状态发起取款。因此，取款通常有一个等待期，以便其他参与者验证其有效性并发起挑战。例如，如果你要求取款并提交一个有效证明来证明你赢了，其他玩家可能会挑战你，利用你最近输给他们的游戏结果生存伪证明，并提交给合约。

- 只针对 plasma：用户容易受到两方面影响（a）需要存储的数据大量增加，因为用户所需数据是 plasma 链全局状态的一部分，而不只是状态通道的对手方的数据，（b）数据扣留攻击（data withholding attack），即，plasma 运营者（区块生产者）试图进行恶意取款，同时扣留用户发起挑战所需的数据。这进一步提高了 Layer 1 上取款安全性逻辑的复杂性。

  以 Plasma Cash 为例，用户会继承且必须存储其收到的每个代币的完整交易记录，这需要耗费大量时间。

**直到 rollup 方案出现，才真正解决了这些棘手的问题。rollup 要求用户退出时所需的一切数据都能在 Layer 1 上获得。每当 Layer 2 上的状态变化时，rollup 运营者都会在 Layer-1 上披露导致本次状态变化的事务数据。因此，Layer 2上的执行和 Layer 1 上的数据更新是同步的。**

**rollup 方案通过数学方法（ZKRU）或密码学货币经济（ORU）保障来确保所有相关参与方都是诚实的。如果 rollup 运营者消失或开始捣乱【滥发信息、审查或（在 optimistic rollup 方案中）实施欺诈】，用户总是可以使用 Layer 1 上的数据来安全地取走资金。这些数据都存储在以太坊 Layer 1 上的 rollup 合约中，因此用户唯一需要信任的就是 Layer 1 会诚实地执行这些合约（其它 Layer 1 合约也采用同样的信任假设，如 MakerDao MCD 和 Aave 等）。**

实际上，只需要一下午时间，你就可以构建出一条以太坊侧链：你只需要在以太坊上构建一个类似智能钱包的基础合约让人们能够存入资金，然后分叉 Geth（为你的侧链选一个新的链 ID 并重新构建即可）

op rollup

https://ethfans.org/posts/almost-everything-you-need-to-know-about-optimistic-rollup-by-georgios

https://upyun-assets.ethfans.org/posts/optimistic-rollups-from-the-bottom

侧链方案：

1. 侧链采用基于clique PoA共识机制设计的go-ethereum
2. 在侧链上实现需要完成的智能合约，通过geth选取新的链id，完成一个侧链
3. 侧链通过RPC远程调用的方式将侧链块的root hash上传至智能合约
4. 使用rollup技术，每当layer2状态变化，侧链都会在layer1上添加事务的数据
   1. 主链上部署rollup相关合约
   2. 侧链上部署rollup相关合约



rollup



https://ethresear.ch/t/understanding-sidechains/8045

# https://docs.plasma.group/en/latest/src/plasma/sidechains.html

https://github.com/ethereum/EIPs/issues/225



尽管条件可能因系统而异，但PoA共识算法基于：

- 活跃的和值得信任的验证者（验证者必须验证自己的身份）;
- 成为验证者的困难性：验证候选人必须做好可能遭遇血本无归和声誉破损的心理准备，选择验证者的过程是繁杂的，但这个过程降低了选到可疑验证者的风险，还有助于和矿工达成长期承诺；
- 验证者认可标准：选择验证者的方法要一致。



https://learnblockchain.cn/2019/11/07/zk-rollup



poa

https://segmentfault.com/a/1190000014544347

http://yangzhe.me/2019/02/01/ethereum-clique/





 跨链

V神2016年给R3写的那篇报告里提到提到了五个use cases，都离不开以上三种，包括：1、资产（原子）交易（Payment-versus-payment or payment-versus-delivery - in technical circles, this concept is also often called "atomic swap"）；2、可转移的资产（Portable assets，资产可以多链之间来回转移和使用）；3、跨链数据预言机（Cross-chain oracles ）；4、资产留置或抵押（Asset encumbrance，某资产在链上被锁定，是否解锁取决于另一链上的结果）5、通用跨链合约（ General cross-chain contracts ）。

> ArcBlock CEO 冒志鸿交流过，他就对 “双向锚定” 的跨链比较悲观，一方面两条链能 “互读” 的难度非常高，“interledger 就是建起桥梁，两条链的东西还得是一致的，但是两条链确实是不一样的”；一方面实际应用需求很少，“99% 都只需要应用级的跨链，只有很少需要 interledger 级别的跨链，比特币和以太坊为了安全性，可能要这种”。
>
> 这个判断，是他以 “数据库历史” 为鉴得出。他介绍，在 80、90 年代，曾经有一个概念叫联邦分布数据库，愿景是：两家企业用的数据库供应商不同，该技术希望数据库的角度让交易保证数据交易的原子性，难度极其高，但是后来证明在现实中根本不需要。“既然可以通过应用层保证一致性，为什么一定要在底层做呢？因此我们其实在整体设计上比较实用主义。”

其实不可能真正意义上某个币真的 “到了” 另外一个链上，大部分只是 B 链上生成了一个 A 链的锚定币，同时 A 链会将等值代币“锁定”。

第一种是双方都不知道自己在跨链，或者说双方不能 “读” 对方，比如中心化交易所这种的。

第二种是其中一条链能读别的链，比如侧链 / 中继链的方式，就是 A 能读 B，B 不能读 A；如果一条 C 链能读到所有链，按理说也能成为一个 “链上” 中介，整个过程就是“A-C-B”。当一条 “侧链” 链接了很多主链时，它就变成一条中继链。

其中资产交换的过程可能是用户把 BTC 和 ETH“充值”到这个链上，各个代币在这个网络中都能流通（其实就是给每个币在这个跨链网络里都有一个锚定币，类似以太坊的 ERC 20），然后分别“提现”。万维链和阿希链的模式有点像这种，他们能跟很多链交互，但是这些链之间不能直接交互。以阿希链为例说明：

用户将 BTC“充值”到阿希链上，需要先把 BTC 转到网关账户（就是比特币链上的一个普通账户，但是管理者是一组节点）；跨链网关收到信息以后锁定网关账户并验证，经过大多数节点验证后；网关会在阿希链上给用户解锁等值数字资产，用户即可在阿希链上使用 BTC。BTC 和 XAS 好像是两个国家的商人，双方不能互相信任而且使用不同的货币，无法直接交易。因此，双方协商了一套规则（相当于跨链网关协议）并且设立了一个专门的交易场所来处理交易，由本国有声望的大商人（相当于网关节点）作为代表来共同管理，这些大商人还需要拥有足够数量的资产作为担保。

第三种是 A 和 B 都能读到对方的，这种理论上可以通过统一的协议实现，不过现在还没有类似协议落地。

说白了，链下也能做“跨链”；只是有人认为链上更安全。

结合万维链的看法，这里的安全可以拆解为两个问题：一是保证跨链信息是正确的，即如何验证原链上的交易状态。如果要考虑到使用 POW 机制的区块链上没有终局状态（始终存在分叉的情况，只是随着确认块的增加，概率逐渐变小），这个问题的复杂度会更高。二是是保证交易的原子性，即如果交易处理的某个环节停止，整个交易能够撤销；否则，部分成功的情况可能会导致双花。

首先是关于如何验证原链上的交易状态，现在我了解到的主要有两种方式

第一种是有一组同时承担两条链节点的个人或联盟，也有可能是一条单独的链，告诉 B 链 A 链上发生什么事，或者告诉 B 某个消息的真的。比如 Ripple 开发的跨账本价值传输开放协议 Interledger，但它不是链，只是一套网关协议。V 神把这种称为**公证人模式（Notary schemes）**。

另一种则是**侧链 / 中继（Sidechains/relays）**，与公证人模式的 “别人告诉 B 链 A 链上发生的事” 不同，中继模式则是更 “直接” 地 B 链自己读 A 链。比如通过验证 A 链区块头和默克尔树等信息验证 A 链上的交易，比如以太坊上的 BTC Relay。

根据公开资料，BTCRelay 的运作机制如此：“一个外部的第三方，被称为 Relayer，发送一个交易到 BTCRelay 的智能合约，内容是最新的比特币区的区块头（当然希望的情况下这个区块头尚未被提交过的）。BTCRelay 基于现存的区块头信息校验发送的区块头的有效性。如果校验通过，则加入到 BTCRelay 维护的比特币区块头链。”

由此，在 BTCRelay 的智能合约里，实现了一个内置的 SPV（简单支付校验）节点，可以用来校验比特币交易的有效性。在以太坊平台的任意用户或者是智能合约都能请求 BTCRelay 来验证，是否某个在比特币网络上存在某个交易。但这种一方面只能实现单向锚定（由于比特币脚本语言不支持），一方面需要以太网络中有 Relayer 不断往合约中提交验证信息，赚取用户手续费。

其实这个模式逻辑上更困扰我的地方在于，既然侧链也需要第三方的 Relayer 提交信息，Relayer 的角色跟“公证人”很类似，不同之处只在于侧链打包了主链的区块头。

V 神认为，利用轻客户端验证技术SPV（简单支付验证，Simple Payment Verificaiton）确实可行，能验证区块头（Header）及其之默克尔树（Merkle tree）中对应的交易。

首先，怎么验证交易，说到这里可能要简单Mark一下什么是 SPV，网络上有不少科普文，其中[iBlockKim](https://www.jianshu.com/u/b55bfcc00734)这个作者写得比较清楚（有删减）：

根据中本聪在比特币白皮书里描述：“不运行全节点也可以验证支付，用户只需要保存所有的区块头（Block Header）就可以了。用户虽然不能自己验证交易，但如果能够从区块链的某处找到相符的交易，他就可以知道网络已经认可了这笔交易，而且得到了网络的多个确认。”

![小明学习笔记 | 一文看懂区块链跨链机制](https://pic.36krcnd.com/avatar/201808/30085644/gugnhkq6x0zfna9j.png!heading)

一个区块链中的信息通过两两打包，最后归纳成一个节点，即根节点（如图中的节点0），区块头中包含了根节点的哈希值，包含了所有交易又大大减少了区块头部的大小。不仅如此，当要搜索某一个交易，比如上图中的23的时候，可通过几步，比如0-2-5-11即可以快速搜到。

因此，SPV在寻找交易时，只需下载寻找区块头而不是整个区块。区块头只有80字节，每小时6个，一年也就4M大小。

那么如何定位区块呢？比特币提供了一种叫做布隆过滤器（Bloom filter）的功能，节点会在通信链路上建立一个这样的过滤器，限制只接受含有目标地址的交易，从而能过滤掉大量不相关的数据，减少客户端不必要的下载量。比如，SPV节点会收到少于1KB的有关区块头和Merkle路径的数据，其数据量只约占一个完整区块（目前大约1MB）的千分之一。

然后怎么打包，用BTC举例的话，侧链协议实际的操作步骤是

提交锁定交易：比特币持有者在 BTC 主链上发送一个特殊交易，把比特币锁定在 BTC 链上。

等待确认：在 BTC 链上等待锁定交易被更多区块确认，以防止该锁定是虚假的交易。

解锁交易：锁定交易确认后，用户在侧链上创建一个解锁交易（也被叫做赎回交易）花掉锁定交易的输出，并提供 SPV 工作量证明（即该解锁交易所在区块的工作量证明），并将赎回交易的输出导入自己在侧链上的地址中。

等待一个竞争期：竞争期也被称作可修改阶段，作用是防双花。而且在此期间，解锁交易不会被打包到区块新转移到侧链上的比特币还不能被使用

如果解锁交易包括了比特币主链更大难度的 SPV 证明，则上一个解锁交易将被替换。

竞争期结束后，该解锁交易将被打包到区块中，用户可以使用他的比特币了（其实是侧链上相对应的代币）。

![小明学习笔记 | 一文看懂区块链跨链机制](https://pic.36krcnd.com/201808/30093020/81uk8ckzlx348cv3!heading)

跟 BTCRelay 类似，中继模式的弊端在于成本太大，V 神也认为验证对方链上的信息会影响速度。可以想象，如果你单纯用 “公证人模式”，只需要等比特币链上确认就行了，可是如果验证信息还要上侧链，就意味等待确认的事情多了很多。阿希链并没有选择打包区块链，就是因为单青峰认为，将区块头打包上链 “成本比较大，没有通用性，解决了比特币的解决不了以太坊的”。同样万维链也没有用，吕旭军表示，Voucher 共识的模式还在验证阶段：工程上 Voucher 信息的提交和验证如果上链，需要耗费较高的链上资源并限制吞吐量；经济上需要更合理的激励机制让 Voucher 成员积极参与并消极作恶。

较为知名的跨链项目还有 Cosmos 和 Polkadot，不过都未落地。在 Cosmos 中，不同空间（Zone，独立区块链）通过 IBC（区块链通信）协议分别和 “中心”（Hub，管理众多 Zone）通信，不同空间的信息包裹经过中心传输。为了保证传输无误，一个证明（Merkle-proof）需要被发布在接收方的区块链上。接收方为了验证这个证明，需要时刻了解发送方的区块头，类似侧链采用的机制。



### 什么是 Rollup？

Rollup 是一种类似于 Plasma 的 Layer-2 扩展方案：用主链上的单个合约来保管所有的资金，并保存一条指向 “侧链” 状态的简洁密码学承诺（通常来说就是一棵由账户、账户余额等状态组成的默克尔树）。侧链的状态是由用户以及链下运营者来维护的，不会占用 Layer-1 的存储空间（这种对存储空间的节约才是可扩展性优势的最大来源）。

Rollup 与 Plasma 有所不同的是，Plasma 会面临交易数据可用性的问题（也是 Plasma 最大的问题）。而 Rollup 则通过在 Layer-1 网络上为每一笔交易公开一些数据解决了这个问题（具体而言，在以太坊上是通过 CALLDATA 交易来实现这个目标的）。因此，几千笔交易可以被打包（roll up）到一个 Rollup 区块中。虽然这种方法的开销是 O(n)，也就是说它的开销会随着交易数量的增加而严格线性增长，但它也提供了实用的 100 倍吞吐量提升，因为 CALLDATA 的开销要比Layer-1的存储和计算便宜很多。



