# MySQL复制

## 复制的基本概念和原理

mysql复制是指从一个mysql服务器（MASTER）将数据**通过日志的方式经过网络传送**到另一台或多台mysql服务器（SLAVE），然后在slave上重放传送过来的日志，以达到和master数据同步的目的。

它的工作原理很简单。首先**确保master数据库上开启了binlog，这是复制的前提**。

- 在slave准备开始复制时，首先**要执行`change master to`语句设置连接到master服务器的连接参数**，在执行该语句的时候要提供一些信息，包括如何连接和要从哪复制binlog，这些信息在连接的时候会记录到slave的datadir下的master.info文件中，以后再连接master的时候将不用再提供这新信息而是直接读取该文件进行连接。
- 在slave上有两种线程，**分别是IO线程和SQL线程**
  - IO线程用于连接master，监控和接受master的binlog。当启动IO线程成功连接master时，**master会同时启动一个dump线程**，该线程将slave请求要复制的binlog给dump出来，之后IO线程负责监控并接收master上dump出来的二进制日志，当master上binlog有变化的时候，IO线程就将其复制过来并写入到自己的中继日志(relay log)文件中。
  - slave上的另一个线程SQL线程用于监控、读取并重放relay log中的日志，将数据写入到自己的数据库中。如下图所示。

站在slave的角度上看，过程如下：

![img](https://images2018.cnblogs.com/blog/733013/201805/733013-20180524163346938-787080496.png)

站在master的角度上看，过程如下（默认的异步复制模式，前提是设置了`sync_binlog=1`，否则binlog刷盘时间由操作系统决定）：

![img](https://images2018.cnblogs.com/blog/733013/201806/733013-20180610221451539-1794738810.png)

1. 数据修改写入master数据库的binlog中。
2. slave的IO线程复制这些变动的binlog到自己的relay log中。
3. slave的SQL线程读取并重新应用relay log到自己的数据库上，让其和master数据库保持一致。

从复制的机制上可以知道，在复制进行前，slave上必须具有master上部分完整内容作为复制基准数据。例如，master上有数据库A，二进制日志已经写到了pos1位置，那么在复制进行前，slave上必须要有数据库A，且如果要从pos1位置开始复制的话，还必须有和master上pos1之前完全一致的数据。如果不满足这样的一致性条件，那么在relay中继日志的时候将不知道如何进行应用而导致数据混乱。**也就是说，复制是基于binlog的position进行的，复制之前必须保证position一致。**

可以选择对哪些数据库甚至数据库中的哪些表进行复制。**默认情况下，MySQL的复制是异步的。slave可以不用一直连着master，即使中间断开了也能从断开的position处继续进行复制。**

## 复制的好处

![img](https://images2018.cnblogs.com/blog/733013/201805/733013-20180524173723814-389803553.png)

**1.提供了读写分离的能力。**

replication让所有的slave都和master保持数据一致，因此外界客户端可以从各个slave中读取数据，而写数据则从master上操作。也就是实现了读写分离。

需要注意的是，为了保证数据一致性，**写操作必须在master上进行**。

通常说到读写分离这个词，立刻就能意识到它会分散压力、提高性能。

**2.为MySQL服务器提供了良好的伸缩(scale-out)能力。**

由于各个slave服务器上只提供数据检索而没有写操作，因此"随意地"增加slave服务器数量来提升整个MySQL群的性能，而不会对当前业务产生任何影响。

之所以"随意地"要加上双引号，是因为每个slave都要和master建立连接，传输数据。如果slave数量巨多，master的压力就会增大，网络带宽的压力也会增大。

**3.数据库备份时，对业务影响降到最低。**

由于MySQL服务器群中所有数据都是一致的(至少几乎是一致的)，所以在需要备份数据库的时候可以任意停止某一台slave的复制功能(甚至停止整个mysql服务)，然后从这台主机上进行备份，这样几乎不会影响整个业务(除非只有一台slave，但既然只有一台slave，说明业务压力并不大，短期内将这个压力分配给master也不会有什么影响)。

**4.能提升数据的安全性。**

这是显然的，任意一台mysql服务器断开，都不会丢失数据。即使是master宕机，也只是丢失了那部分还没有传送的数据(异步复制时才会丢失这部分数据)。

**5.数据分析不再影响业务。**

需要进行数据分析的时候，直接划分一台或多台slave出来专门用于数据分析。这样OLTP和OLAP可以共存，且几乎不会影响业务处理性能。

## 复制分类和它们的特性

MySQL支持4种不同的同步方式：同步（synchronous）、半同步（semisynchronous）、异步（asynchronous）、延迟（delayed）。

### 同步复制

客户端发送DDL/DML语句给master，master执行完毕后还需要**等待所有的slave都写完了relay log才认为此次DDL/DML成功，然后才会返回成功信息给客户端**。同步复制的问题是master必须等待，所以延迟较大，在MySQL中不使用这种复制方式。

![img](https://images2018.cnblogs.com/blog/733013/201805/733013-20180524204948187-2045181991.png)

### 半同步复制

客户端发送DDL/DML语句给master，master执行完毕后**还要等待一个slave写完relay log并返回确认信息给master，master才认为此次DDL/DML语句是成功的，然后才会发送成功信息给客户端**。半同步复制只需等待一个slave的回应，且等待的超时时间可以设置，超时后会自动降级为异步复制，所以在局域网内(网络延迟很小)使用半同步复制是可行的。

![img](https://images2018.cnblogs.com/blog/733013/201805/733013-20180524205148967-868029789.png)

### 异步复制

客户端发送DDL/DML语句给master，**master执行完毕立即返回成功信息给客户端，而不管slave是否已经开始复制**。这样的复制方式导致的问题是，当master写完了binlog，而slave还没有开始复制或者复制还没完成时，**slave上和master上的数据暂时不一致，且此时master突然宕机，slave将会丢失一部分数据。如果此时把slave提升为新的master，那么整个数据库就永久丢失这部分数据。**

![img](https://images2018.cnblogs.com/blog/733013/201805/733013-20180524205215240-203795747.png)

### 延迟复制

延迟复制就是故意让slave延迟一段时间再从master上进行复制。

