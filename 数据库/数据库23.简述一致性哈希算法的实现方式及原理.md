# 有一堆数据和两台服务器，如何保证数据均匀的存储在这两台服务器上？

方案1. 拿到一个数据，计算hash(key) % 2，如果等于0， 存到redis1中，否则存到redis2中

问题：扩容集群，增加redis3，要hash(key) % 3，要重新将原有数据重新分布

解决：使用hash一致性算法

使用hash一致性算法主要解决是当集群中有机器发生变动，不至于发生大量的数据移动问题。

# hash一致性算法原理

### 原理

有一个hash环，上面分布了2^32次方个点（0~2^32 - 1）

1. 三台redis服务器，计算hash(ip + 编号) % 2 ^ 32， 在环上一定能找到某个点

```
|------|
2      1
|      |
|---3--|
```

2. 数据应该存储在哪里，计算hash(key) % 2 ^ 32，在环上一定能找到某个点
3. 数据顺时针行走，遇到第一台服务器，就存储在某台服务器上
4. 新增一台redis4服务器，若redis4在redis1和redis3之间，只用将redis1到redis4之间的数据移动到redis4上（3中的数据不删除，数据有重叠，但是多一点也有备份）

```
|------|
2      1
|      |
|---3--4
```

### 为什么是2 ^ 32次方？

因为点越多，发生数据倾斜的概率越低

### 删除一台服务器怎么办？

将redis3进行移除，只用移动redis1到redis3中数据进行变动

```
|------|
2      1
|      |
|---3--|
```

```
|------|
2      1
|      |
|------|
```

# 带来数据倾斜的问题

数据倾斜问题：

1. 存储框架数据倾斜：一个存储设备存储了大量数据，其他存储设备存储少量数据
2. 计算框架数据倾斜：一个计算设备做了大量计算，其他计算设备做了少量计算

两个redis服务器节点离得很近就会导致数据倾斜

解决：

### 使用虚拟节点

将每台redis服务器虚拟成2个redis节点

```
|------|
1_1    1_0
|      |
|2_1---2_0
```

虚拟多少节点，看经验值，10台redis服务器，可以虚拟100-200节点，保证环上有1000-2000个虚拟节点；5台redis服务器，可以虚拟200-400节点，保证环上有1000-2000个虚拟节点





