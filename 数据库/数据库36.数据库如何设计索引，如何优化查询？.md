# 数据库如何设计索引，如何优化查询？

### 索引的类型

normal：表示普通索引

```sql
-- 普通索引 添加INDEX
ALTER TABLE `table_name` ADD INDEX index_name ( `column` )
```

unique：表示唯一的，不允许重复的索引，如果该字段信息保证不会重复例如身份证号用作索引时，可设置为unique

```sql
-- 唯一索引 添加UNIQUE
ALTER TABLE `table_name` ADD UNIQUE ( `column` )
```

full text：表示全文搜索的索引。 FULLTEXT 用于搜索很长一篇文章的时候，效果最好。用在比较短的文本，如果就一两行字的，普通的 INDEX 也可以。

```sql
-- 全文索引 添加FULLTEXT
ALTER TABLE `table_name` ADD FULLTEXT ( `column`)
```

主键索引

```sql
-- 主键索引 添加PRIMARY KEY
ALTER TABLE `table_name` ADD PRIMARY KEY ( `column` )
```

组合索引

```sql
ALTER TABLE `table_name` ADD INDEX index_name ( `column1`, `column2`, `column3` )
```

总结，索引的类别由建立索引的字段内容特性来决定，通常normal最常见。

### 索引建立的原则

基于合理的数据库设计，经过深思熟虑后为表建立索引，是获得高性能数据库系统的基础。而未经合理分析便添加索引，则会降低系统的总体性能。索引虽然说提高了数据的访问速度，但同时也增加了插入、更新和删除操作的处理时间。

是否要为表增加索引、索引建立在那些字段上，是创建索引前必须要考虑的问题。解决此问题的一个比较好的方法，就是分析应用程序的业务处理、数据使用，为经常被用作查询条件、或者被要求排序的字段建立索引。基于优化器对SQL语句的优化处理，我们在创建索引时可以遵循下面的一般性原则：

1. 为经常出现在关键字order by、group by、distinct后面的字段，建立索引
   在这些字段上建立索引，可以有效地避免排序操作。如果建立的是复合索引，索引的字段顺序要和这些关键字后面的字段顺序一致，否则索引不会被使用
2. 在union等集合操作的结果集字段上，建立索引。其建立索引的目的同上
3. 为经常用作查询选择的字段，建立索引
4. 在经常用作表连接的属性上，建立索引
5. 考虑使用索引覆盖。对数据很少被更新的表，如果用户经常只查询其中的几个字段，可以考虑在这几个字段上建立索引，从而将表的扫描改变为索引的扫描
6. 定义主键的数据列一定要建立索引
7. 定义有外键的数据列一定要建立索引
8. 对于需要在指定范围内的快速或频繁查询的数据列
9. 经常用在WHERE子句中的数据列
10. 对于那些查询中很少涉及的列，重复值比较多的列不要建立索引
11. 对于定义为text、image和bit的数据类型的列不要建立索引
12. 对于经常存取的列避免建立索引
13. 限制表上的索引数目。对一个存在大量更新操作的表，所建索引的数目一般不要超过3个，最多不要超过5个。索引虽说提高了访问速度，但太多索引会影响数据的更新操作
14. 对复合索引，按照字段在查询条件中出现的频度建立索引。在复合索引中，记录首先按照第一个字段排序。对于在第一个字段上取值相同的记录，系统再按照第二个字段的取值排序，以此类推。因此只有复合索引的第一个字段出现在查询条件中，该索引才可能被使用，因此将应用频度高的字段，放置在复合索引的前面，会使系统最大可能地使用此索引，发挥索引的作用
15. 避免在取值朝一个方向增长的字段（例如：日期类型的字段）上，建立索引；对复合索引，避免将这种类型的字段放置在最前面。
    由于字段的取值总是朝一个方向增长，新记录总是存放在索引的最后一个叶页中，从而不断地引起该叶页的访问竞争、新叶页的分配、中间分支页的拆分。此外，如果所建索引是聚集索引，表中数据按照索引的排列顺序存放，所有的插入操作都集中在最后一个数据页上进行，从而引起插入“热点”。
16. 删除不再使用，或者很少被使用的索引

### 如何优化查询

1. 使用索引

   > 应尽量避免全表扫描，首先考虑在where以及order by，group by涉及的列上建立索引

2. 优化SQL语句

   > 1. 通过explain（查询优化神器）用来查看SQL语句的执行效果，可以帮助选择更好的索引和优化查询语句，写出更好的优化语句。通常我们可以对比较复杂的尤其是涉及到多表的SELECT语句，把关键字explain加到前面，查看执行计划，例如：
   >
   >    ```sql
   >    explain select * from news;
   >    ```
   >
   > 2. 任何地方都不要使用select * from ，用具体的字段列表代替“*”，不要返回用不到的任何字段。
   >
   > 3. 不在索引列做运算或者使用函数。
   >
   > 4. 查询尽可能使用limit减少返回的行数，减少数据传输时间和带宽浪费。

3. 优化数据库对象

   >1. 优化表的数据库类型
   >
   >   使用procedure analyse()函数对表进行分析，该函数可以对表中列的数据类型提出优化建议。能小就用小。表数据类型第一个原则是：使用能正确的表示和储存数据的最短类型。这样可以减少对磁盘空间，内存，cpu缓存的使用。
   >
   >   ```sql
   >   select * from  表名  procedure analyse();
   >   ```
   >
   >2. 对表进行拆分
   >
   >   第一种：垂直拆分
   >
   >   把主键和一些列放在一个表中，然后把主键和另外的列放到另一个表中。如果一个表中某些列常用，而另外一些列不常用，则可以用垂直拆分
   >
   >   第二种：水平拆分
   >
   >   根据一列或者多列数据的值把数据行放到第二个独立的表中
   >
   >3. 使用中间表来提高查询速度
   >
   >   创建中间表，表结构和原表结构完全相同，转移要统计的数据到中间表，然后在中间表上进行统计，得出想要的结果

4. 硬件优化

   >1. CPU的优化：选择多核和主频高的CPU
   >2. 内存的优化：使用更大的内存，将尽量多的内存分配给MySQL做缓存
   >3. 磁盘I/O的优化
   >
   >4. 调整磁盘调度算法

5. MySQl自身的优化

   >对MySQl自身的优化主要是对其配置文件my.cnf中的各项参数进行优化调整。如指定MySQL查询缓冲区的大小，指定MySQl允许的最大连接进程数等。

6. 应用优化

   >1. 使用数据库连接池
   >
   >2. 使用查询缓存
   >
   >   它的作用是存储select查询的文本及其相应结果。如果随后收到一个相同的查询，服务器会从查询缓存中直接查询结果。查询缓存适用于的对象是更新不频繁的表，当表中数据更改后，查询缓存中相关条目就会被清空。

