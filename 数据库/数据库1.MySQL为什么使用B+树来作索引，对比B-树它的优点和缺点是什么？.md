# MySQL为什么使用B+树来做索引，对比B-树，它的优点和缺点是什么

MySQL数据一般放在磁盘中，读取数据会有访问磁盘操作。当大规模数据存储到磁盘中，定位会花费时间。

几种数据结构对比：

### 哈希

直接查询，从多个数据中查找某条记录，计算该条数据的哈希值便可快速定位，且复杂度为O(1)。

索引的选择是与存储引擎相关的，在MySQL中memory存储引擎使用的引擎是hash表，且innodb支持自适应hash。

问题1.hash碰撞，必须使用很好的hash算法，避免产生hash碰撞

问题2.哈希表需要大量内存空间

问题3.根据下标找数据，范围查询效率低

### 二叉搜索树

```
     4
   /   \
  2     9
 / \   / \
1   3 6   10
```

直接查询：查6。先找到4，4<6，查找4的右子树；找到9，9>6，找9的左子树；找到6。一共查找3次，优于顺序查找8次。

范围查询：查找大于4的数据，遍历4的右子树即可。

但是遇到已有序的数组，就会发生退化成链表的情况。

```
1
 \
  2
   \
    3
```

### 平衡二叉树

查询的速度很快，但缺点如下：

1. 维护树的代价非常大，在插入和更新时，需要多次左旋和右旋来维持平衡。

2. 数据量多的时候，树高会很高，要执行多次I/O操作。

3. 范围查询与二叉树相同。

### 红黑树

树高会很高，需要执行多次I/O操作。原因只有二查。

## B-树

```
Max.Degree = 6
    3    6
  /     /    \
1 2 | 4 5 | 7 8 9
```

### m阶B-树特点

1. 一种二叉搜索树。
2. 除根节点外的所有非叶节点至少含有(m/2（向上取整）-1)个关键字，每个节点最多有m-1个关键字，并且升序排序。
3. 每个节点最多有m-1个关键字。

3阶B-树能存储多少数据，若一条数据假设为1k， 每个磁盘块可以存16条数据，3层可以存储16✖16✖16=4096条数据

### m阶B+树特点

1. 有n棵子树的非叶子结点中含有n个关键字，这些关键字不保存数据，只用来索引，所有数据都保存在叶子节点。

2. 所有的叶子结点中包含了全部关键字的信息，及指向含这些关键字记录的指针，且叶子结点本身依关键字的大小自小而大顺序链接（叶子节点组成一个链表）。

3. 所有的非叶子结点可以看成是索引部分，结点中仅含其子树中的最大（或最小）关键字。

4. 通常在B+树上有两个头指针，一个指向根结点，一个指向关键字最小的叶子结点。

5. 同一个数字会在不同节点中重复出现，根节点的最大元素就是B+树的最大元素。

```
               8 15
        /                \
    2  5  8             11 15
  /     /     \        /      \
1 2 -> 3 5 -> 6 8 -> 9 11 -> 13 15 
```

3阶B+树能存储多少数据，因为不存储数据，只存储关键字和地址，若一条数据假设为10字节， 每个磁盘块可以存1600条数据，3层可以存储1600✖1600✖16=40960000条数据

索引的类型使用int还是varchar，谁占用的空间小就使用谁。从字段类型的执行效率上，int最高，varchar最低。int类型更容易建立索引和进行检索，毕竟数字类型是数据库检索的基础，char类型的毕竟需要经过转换，而varchar就更复杂了，其排序不仅需要转换和计算，还需要访问和遵循数据库的排序规则（实际上char也需要排序规则），而消耗的资源也更大。因此，通常在数据库设计中，都是尽量使用int类型字段而不是字符类型字段，这在大型和超大型数据库的优化中，有明显的性能差异。

MySQL一般情况下索引树为3-4层，足以支撑千万数据量，需要数据量来推断。

### B-树与B+树的区别

B-树每个节点都存储数据，所有节点组成这棵树。B+树只有叶子节点存储数据，叶子节点包含了这棵树的所有数据，所有的叶子结点使用链表相连，便于区间查找和遍历，所有非叶节点起到索引作用。

B-树中叶节点包含的关键字和其他节点包含的关键字是不重复的，B+树的索引项只包含对应子树的最大关键字和指向该子树的指针，不含有该关键字对应记录的存储地址。

B-树除根节点外的所有非叶节点至少含有(m/2（向上取整）-1)个关键字，每个节点最多有m-1个关键字，具有n个关键字的节点包含n+1棵子树；B+树中除根节点外的所有非叶节点至少含有m/2（向上取整）个关键字，每个节点最多有m个关键字，根节点为(1,m)，具有n个关键字的节点包含n棵子树。

B+树中查找，无论查找是否成功，每次都是一条从根节点到叶节点的路径。

### B-树的优点

B-树的每一个节点都包含key和value，因此经常访问的元素可能离根节点更近，因此访问也更迅速。

### B+树的优点

1. 所有的叶子结点使用链表相连，便于区间查找和遍历。B-树则需要进行每一层的递归遍历，相邻的元素可能在内存中不相邻。
2. B+树的中间节点不保存数据，能容纳更多节点元素。

### B-和B+树共同优点
数据库索引是存储在磁盘上的，当数据量大时，就不能把整个索引全部加载到内存了，只能逐一加载每一个磁盘页（对应索引树的节点），页是内存与磁盘进行交互的最小逻辑单位，可读取4k的整数倍，一般为4k或者8k，MySQL加载的磁盘页为16k。所以我们要减少IO次数，对于树来说，IO次数就是树的高度，而“矮胖”就是b树的特征之一，m的大小取决于磁盘页的大小。

### B+树缺点

1. 主键不是有序递增的，导致每次插入数据产生大量的数据迁移和空间碎片。
2. 即使主键是有序递增的，大量写请求的分布仍是随机的。




