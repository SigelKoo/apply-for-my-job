# 简述主从复制以及读写分离的使用场景

### 主从复制

大并发情况下，多个客户端访问多个拥有相同数据的服务器

binlog mysql server

redo log innodb

undo log innodb

连接时连接主数据库，执行DML要落盘，形成bin log日志，有bin log日志后，通过两个线程I/O thread和SQL thread。I/O thread将主机器中bin log日志中内容同步到从机器中，将接收到的日志进行落盘，形成relay log中继日志。SQL thread去读取relay log来将数据恢复到从数据库中。



哪个步骤会造成延时？

IO分为顺序IO和随机IO，随机IO涉及到寻址的时间，顺序IO是连续的，更快

在主服务器落盘时生成文件是顺序IO，很快，不用浪费时间；IO线程拉取数据也是顺序IO；在从机器将顺序的数据进行落盘时也是顺序读写。relay log执行时是随机读写，因为不知道修改relay log哪一行的数据，执行时是随机寻址。使用并行赋复制



主从复制延迟产生的原因有哪些？

1. 在某些部署环境中，备库所在的机器性能要比主库所在的机器性能差。此时如果机器的资源不足的话就会影响备库同步的效率
2. 备库充当了读库，一般情况下主要写的压力在于主库，那么备库会提供一部分读的压力，而如果备库的查询压力过大的话，备库的查询消耗了大量的CPU资源，那么必不可少的就会影响同步的速度
3. 大事务执行，如果主库的一个事务执行了10分钟，而binlog的写入必须要等待事务完成之后，才会传入备库，那么此时在开始执行的时候就已经延迟了10分钟了
4. 主库的写操作是顺序写binlog，从库单线程去主库顺序读binlog，从库取到binlog之后在本地执行。mysql的主从复制都是单线程的操作。但是由于主库是顺序写，所以效率很高，而从库也是顺序读取主库的日志，此时的效率也是比较高的，但是当数据拉取回来之后变成了随机的操作，而不是顺序的，所以此时成本会提高
5. 从库在同步数据的同时，可能跟其他查询的线程发生锁抢占的情况，此时也会发生延时
6. 当主库的TPS并发非常高的时候，产生的DDL数量超过了一个线程所能承受的范围的时候，那么也可能带来延迟
7. 在进行binlog日志传输的时候，如果网络带宽也不是很好，那么网络延迟也可能造成数据同步延迟

解决

多个SQL thread并行向从数据库中写入信息，通常有8-16个

顺序是如何保证的？

1. 不能造成更新覆盖。这就表示更新同一行的两个事务，必须被分发到同一个worker中
2. 同一个事务不能被拆开，必须放到同一个worker中

我怎么知道执行的是同一条记录？

粒度，按库->表->行 分发。库分发，不同库之间并行运行；不同表之间并行执行；行，不同行之间并行执行，执行效率更高。

5.7之后，复制延迟问题不存在

并行复制策略的思想有：

1. 同时处于prepare状态的事务，在备库执行是可以并行的
2. 处于prepare状态的事务，与处于commit状态的事务之间，在备库上执行也是可以并行的