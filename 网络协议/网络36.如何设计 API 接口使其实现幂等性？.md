# 如何设计 API 接口使其实现幂等性？

我们实际系统中有很多操作，是不管做多少次，都应该产生一样的效果或返回一样的结果。

1. 前端重复提交选中的数据，应该后台只产生对应这个数据的一个反应结果；
2. 我们发起一笔付款请求，应该只扣用户账户一次钱，当遇到网络重发或系统bug重发，也应该只扣一次钱
3. 发送消息，也应该只发一次，同样的短信发给用户，用户会哭的
4. 创建业务订单，一次业务请求只能创建一个，创建多个就会出大问题等等很多重要的情况都需要幂等的特性来支持。 

### 解决方案

1. 乐观锁

   多版本并发控制，该策略主要使用 update with condition（更新带条件来防止）来保证多次外部请求调用对系统的影响是一致的。

   在系统设计的过程中，合理的使用乐观锁，通过 version 或者 updateTime（timestamp）等其他条件，来做乐观锁的判断条件，这

   样保证更新操作即使在并发的情况下，也不会有太大的问题

2. Token机制，防止页面重复提交

   数据提交前要向服务的申请 token，token 放到 redis 中，设置 token 有效时间

   客户端每次在调用接口的时候，需要在请求头中，传递令牌参数，每次令牌只能用一次，提交数据后后台校验 token，同时删除

   token，生成新的 token 返回

3. 数据库唯一索引

   特殊的表单，可以使用数据唯一索引，重复插入报错，进行限制重复提交

4. 查询操作

   查询一次和查询多次，在数据不变的情况下，查询结果是一样的。select是天然的幂等操作

5. 删除操作

   删除操作也是幂等的，删除一次和多次删除都是把数据删除。（注意可能返回结果不一样，删除的数据不存在，返回0，删除的数据多条，返回结果多个）

6. 悲观锁

   获取数据的时候加锁获取

   ```sql
   select * from table_xxx where id='xxx' for update
   ```

7. select + insert

   并发不高的后台系统，或者一些任务JOB，为了支持幂等，支持重复执行，简单的处理方法是，先查询下一些关键数据，判断是否已经执行过，在进行业务处理，就可以了