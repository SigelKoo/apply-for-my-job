# TCP滑动窗口以及重传机制

#### TCP流量控制

流量控制：让发送方慢点（发送方发送速率太快，导致接收方来不及接收，出现严重的丢包现象），要让接收方来得及接收。

TCP利用滑动窗口机制实现流量控制：在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，即接收窗口rwnd （接收方设置确认报文段的窗口字段来将rwnd通知给发送方），**发送方的发送窗口取接收窗口rwnd和拥塞窗口cwnd的最小值。**

滑动窗口：发送窗口大小可以动态变化

#### 一个栗子

A向B发送数据，连接建立时，B告诉A：“我的rwnd=400（字节）”，假设每一个报文段100B，报文段序号初始值为1。

![image-20201229225315224](https://img-blog.csdnimg.cn/img_convert/fae458c0ebae5be00687b8bd80840308.png)

可以看到，最后主机 B 将 rwnd 设置为 0，不允许主机 A 再发送数据，那么什么时候主机 A 能再发送数据呢？当主机 B 的传输层将缓冲区的数据交付给上层应用之后，会腾出一些缓冲区空间，这时候可以向主机 A 发送报文，并将 rwnd 设置为接收窗口的值。若报文丢失，A希望B能让他继续发送数据；B希望A能给他发送数据，相互等待，进入死锁。

TCP为每一个连接设有一个持续计时器，只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器。若持续计时器设置的时间到期，就发送一个零窗口探测报文段。接收方收到探测报文段时给出现在的窗口值。若窗口仍然是0，那么发送方就重新设置持续计时器。这样就能保证包含 rwnd 的报文即使丢失也能得到重传。

#### 重传机制

##### 超时重传

当发送端发送数据，发生丢包时，则丢掉的包的ACK一直不会返回。此时发送端就一直等那个ACK返回，若超时，则重传该数据包。对于超时时间RTO，有很多复杂的算法。RTO的选择很重要，选短了，可能只是返回时间长但并未丢包，却当做丢包。选长了，迟迟不发丢的包也是个问题。

##### 快速重传

快重传要求接收方在收到一个失序的报文段后就立即发出重复确认（为的是使发送方及早知道有报文段没有到达对方）而不要等到自己发送数据时捎带确认。快重传算法规定，发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段，而不必继续等待设置的重传计时器时间到期。