# 简述TCP协议的延迟ACK和累计应答

### 延迟确认（延迟ACK）

在许多情况下，TCP并不对每个到来的数据包都返回ACK，利用TCP的累积ACK字段就能实现该功能
累积确认可以允许TCP延迟一段时间发送ACK，以便将ACK和相同方向上需要传的数据结合发送。这种捎带传输的方法经常用于批量数据传输
显然，TCP不能任意时长地延迟ACK；否则对方会误认为数据丢失而出现不必要的重传
![img](https://img-blog.csdnimg.cn/20200131100841691.png)

>不同操作系统对延迟确认的实现
>采用延时ACK的方法会减少ACK传输数目，可以一定程度地减轻网络负载。对于批量数据传输通常为2:1的比例。基于不同的主机操作系统，延迟发送ACK的最大时延可以动态配置。
>**Linux使用了一种动态调节算法**，可以在每个报文段返回一个ACK （称为“快速 确认”模式）与传统延时ACK模式间相互切换。
>**Mac OS X中，可以改变系统变量net.inet. tcp.delayed_ack值来设置延时ACK**。可选值如下：禁用延时(设为0)，始终延时(设为1)，每隔一个包回复一个ACK(设为2)，自动检测确认时间(设为3)。默认值为3
>**最新的 Windows版本中，注册表项中，每个接口的全局唯一标识（GUID）都不同（IG表示被引用的特定网络接口的GUID）。**TcpAckFrequency值（需要被添加）可以设为0-255，默认为2。它代表延时ACK计时器超时前在传的ACK数目。将其设为1表明对每个收到的报文段都生成相应的ACK。ACK计时器值可以通过TcpDelAckTicks注册表项控制。该值可设为2 - 6，默认为2。它以百毫秒为单位，表明在发送延时ACK前要等待百毫秒数
>
>![img](https://img-blog.csdnimg.cn/20200131101357471.png)

### 累计应答

TCP的可靠性，超时重传怎么实现，M1、M2、M3、M4、M5，丢失M2；怎么重传M2？为什么不用重传M4、M5？

因为每个TCP报文被发送时，都会设置一个重传定时器，若定时期到了还没收到ack包，则应重传。为什么不用重传M4、M5？则可由此文回答：因为采用了累积确认。有例如下：

1. Server 发送80个字节 Part1，seq = 1
2. Server 发送120个字节Part2，Seq = 81
3. Server发送160个字节Part3，Seq = 201，此包由于其他原因丢失
4. Client收到前2个报文段，并发送ACK = 201
5. Server发送140个字节Part4， Seq = 361
6. Server收到Client对于前两个报文段的ACK，将2个报文从窗口中移除，窗口有200个字节的余量
7. 报文3的重传定时器到期，没有收到ACK，进行重传
8. 这个时候Client已经收到报文4，存放在缓冲区中，也不会发送ACK【累计通知，发送ACK就表示3也收到了】，等待报文3，报文3收到之后，一块对3，4进行确认
9. Server收到确认之后，将报文3，4移除窗口，所有数据发送完成
   