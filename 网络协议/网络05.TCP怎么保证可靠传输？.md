# TCP怎么保证可靠传输？

在TCP协议中，网络层IP协议提供最大努力交付，是不可靠传输；所以就需要传输层TCP来实现可靠传输。

**可靠**：保证接收方进程从缓存区读出的字节流与发送方发出的字节流是完全一样的。（按序、未丢失）

#### TCP实现可靠传输的机制

1. 校验
2. 序号
3. 确认
4. 重传

##### 校验

伪首部（伪IP首部）只在计算校验和才出现，不向下也不向上递交

17：封装UDP报文的IP数据报首部协议字段是17

6：封装TCP报文的IP数据报首部协议字段是6

![image-20201229215044621](https://img-blog.csdnimg.cn/img_convert/858f417522a875cea30c06342624ee17.png)

1. 填上伪首部
2. 伪首部+首部+数据部分采用二进制反码求和（首部中的检验和字段是发送方计算得到的检验和）
3. 结果全为1则无差错，否则丢弃数据报或者交给应用层附上出差错的警告（差错控制交由上层实现）。

##### 序号

![image-20201229223900166](https://img-blog.csdnimg.cn/img_convert/cbb1e7c6f259b7e7f8ea4995465b52a9.png)

给每个字节编上序号，由字节（不定量）组成报文段。一个字节占一个序号。 序号字段指的是一个报文段第一个字节的序号。字节组成报文段大小取决于链路层MTU。

##### 确认

接收方收到数据会返回一个确认报文，报文段首部的确认字段为期望接收到的字节序列的起始编号。

![image-20201229223656446](https://img-blog.csdnimg.cn/img_convert/1f9102931001e70252160790e9e3f554.png)

![image-20201229223718010](https://img-blog.csdnimg.cn/img_convert/db0cde12979772f64d1102403049eb19.png)

报文123已经传过去了还要再保存是因为若网络出现问题，发送方可能重发，要接收方应用确定收到才能从缓存中去除。若报文456未到，报文78先到，接收方还会发送消息告诉发送方要报文4开头的报文段。

##### 重传

确认重传不分家，TCP的发送方在规定的时间内（重传时间 ）没有收到确认就要重传已发送的报文段。即超时重传。

TCP采用自适应算法，动态改变重传时间RTTs（加权平均往返时间）。TCP传输往返时间是指发送端从发送TCP包开始到接收到它的立即响应所耗费的传输时间。

报文123传送后获得RTT，报文456传送后获得RTT，即可计算RTTs，报文78传送后，继续计算RTTs，....以此类推。

1. 重传时间过小：导致传播时间较长的报文段还没到呢，就要重传，增加网络的负担
2. 重传时间过大：导致网络的空闲时间较多，通信使用率降低

##### 冗余ACK（冗余确认）

每当比期望序号大的失序报文段到达时，发送一个冗余ACK，指明下一个期待字节的序号。比如发送方已发送1，2，3，4，5报文段：

接收方收到1，返回给1的确认（确认号为2的第一个字节）
接收方收到3，仍返回给1的确认（确认号为2的第一个字节）
接收方收到4，仍返回给1的确认（确认号为2的第一个字节）
接收方收到5，仍返回给1的确认（确认号为2的第一个字节）

发送方收到3个对于报文段1的冗余ACK ，则认为2报文段丢失，将重传2号报文段（快速重传机制）
