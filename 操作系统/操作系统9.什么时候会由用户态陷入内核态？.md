# 什么时候会由用户态陷入内核态？

### 区别：

**用户空间**：用户可以操作和访问的空间，这个空间通常存放我们用户自己写的数据等

**内核空间**：系统内核来操作的一块空间，这块空间里面存放系统内核的函数、接口等

当一个程序运行时，如果它是在用户空间下执行，我们把此时运行得程序的这种状态成为用户态，而当这段程序执行在内核的空间执行时，这种状态称为内核态。

当一个任务（进程）执行系统调用而陷入内核代码中执行时，我们就称进程处于内核状态。此时处理器处于特权级最高的（0级）内核代码。当进程处于内核态时，执行的内核代码会使用当前的内核栈。每个进程都有自己的内核栈。

当进程在执行用户自己的代码时，则称其处于用户态。即此时处理器在特权级最低的用户代码中运行。当正在执行用户程序而突然中断时，此时用户程序也可以象征性地处于进程的内核态。因为中断处理程序将使用当前进程的内核态。

### 用户态和内核态的转换

- 系统调用

  内中断中使用陷入指令

- 异常

  若当前执行的指令是非法的，或执行指令的参数是非法的，那么就会引发一个内中断信号。

- 中断

  CPU上会运行两种程序，一种是操作系统的内核程序，一种是应用程序。内核程序是整个系统的管理者，在计算机启动时，CPU处于内核态，只是在合适的情况下，操作系统内核会把CPU的使用权主动让给应用程序。一个应用程序在上CPU运行之后，它就会一直运行下去，除非发送中断。

  **”中断”是让操作系统内核夺回CPU使用权的唯一途径，使CPU由用户态变为内核态。**

  中断分为内中断与外中断

  内中断：与当前执行的指令有关，中断信号来源于 CPU内部
  外中断：与当前执行的指令无关，中断信号来源于 CPU外部

  > **内中断**
  >
  > 1. 试图在用户态下执行特权指令
  >
  >    ![在这里插入图片描述](https://www.pianshen.com/images/148/bbd561121ba3cef45b879040d5e6a72c.png)
  >
  > 2. 执行除法指令时发现除数为0
  >
  >    总之，若当前执行的指令是非法的，或执行指令的参数是非法的，那么就会引发一个中断信号。
  >
  > 3. 有时候应用程序想请求操作系统内核的服务，此时会执行一条特殊的指令——陷入指令，该指令会引发一个内部中断信号。

  >**外中断**
  >
  >1. 时钟中断——由时钟部件发来的中断信号
  >
  >   ![在这里插入图片描述](https://www.pianshen.com/images/650/67e11722c2fc033419861ecf62b2e332.png)
  >
  >如图：系统中想要并发的运行两个应用程序，首先应用程序1运行在用户态，CPU执行其指令，假如当CPU执行两条指令后，时钟部件检测已经执行过了50ms，于是时钟部件会给CPU发送一个中断信号，此时CPU会暂停执行应用程序1，转而去执行处理时钟中断的内核程序，去处理这个中断信号。
  >
  >![在这里插入图片描述](https://www.pianshen.com/images/961/e7dd3f93c2f6d453ef636f2fcf2ee7f9.png)
  >
  >此时CPU由用户态转为内核态，在处理中断信号的内核程序中，操作系统内核发现应用程序1已经用了50ms，为了公平起见，操作系统内核决定接下来让另一个应用程序2上CPU运行。
  >
  >CPU又从内核态转为用户态，CPU执行应用程序2的指令，同样的，时钟部件检测已经过了50ms，于是时钟部件再次会给CPU发送一个中断信号，此时CPU又会暂停执行应用程序2，转而去执行处理时钟中断的内核程序。
  >
  >在处理中断信号的内核程序中，操作系统内核发现应用程序2已经用了50ms，为了公平起见，操作系统内核决定接下来又让应用程序1上CPU运行，于是将CPU的使用权让给应用程序1，然后应用程序1就会执行它之后的未执行的指令，依次往复…
  >
  >2. I/O中断——由输入/输出设备发来的中断信号
  >
  >除了时钟部件，当输入输出任务完成时，输入/输出设备会向CPU发送中断信号…

  当CPU检测到中断信号后，会根据中断信号的类型去查询”中断向量表“，以此来找到相应的中断处理程序在内存中的存放位置。

  ![在这里插入图片描述](https://www.pianshen.com/images/647/1eb5717b7bf97b5b6f6b84b4b0bf205f.png)